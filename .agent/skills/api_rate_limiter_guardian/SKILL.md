---
name: API Rate Limiter Guardian
description: 外部API（Gemini, OpenAI等）を使用する際に、レート制限による破綻を未然に防ぐ自律的なガバナンス・スキル。
---

# API Rate Limiter Guardian

## 🎯 使命
外部APIを利用する処理を実行する前に、必ずこのスキルのプロトコルに従い、**制限超過による作業停止を未然に防げ**。

## ⚠️ このスキルが生まれた理由（教訓）
2026年2月1日、Gemini APIを無計画に連続実行した結果、429エラーが約200件発生。1日分のAPI枠を使い果たし、本来のタスクが完了できなかった。**この失敗を二度と繰り返すな。**

---

## 1. 🔍 事前調査フェーズ（Pre-Flight Check）

### 1.1 制限値の把握
処理を開始する**前に**、対象APIの制限を必ず確認せよ。

| API | 無料枠 RPM | 無料枠 RPD | トークン制限 |
|-----|-----------|-----------|-------------|
| Gemini 2.5/3 | 100 | 2,000 | 128k-2M |
| OpenAI (GPT-4o+) | 20-50 | 5,000 | 128k |
| Claude 3.5+ | 10 | 2,000 | 200k |

*※2026年2月時点の観測値に基づく目安。最新の Quota は Google AI Studio 等で確認せよ。*

### 1.2 使用量の見積もり
バッチ処理を行う場合、**処理件数 × 1件あたりのリクエスト数**を計算し、制限内に収まるか確認せよ。

**例**: 12物件 × 5ファイル × 2リクエスト（アップロード＋解析）= 120リクエスト
→ RPD 1,500なら余裕だが、RPM 60なら最低2分かかる

---

## 2. 🧪 段階的テスト・プロトコル（Graduated Testing）

### ステップ1: 単体テスト（1件だけ）
**必ず1件だけ**で完全な成功を確認してから、バッチ処理に進め。
- [ ] 処理が最後まで完走するか？
- [ ] 期待通りの出力ファイルが生成されたか？
- [ ] APIエラーは発生しなかったか？

### ステップ2: 小規模バッチ（3-5件）
単体テスト成功後、3-5件の小規模バッチを実行し、累積の挙動を確認せよ。

### ステップ3: 本番バッチ
上記が問題なければ、本番の大規模バッチを実行。ただし、**リクエスト間に十分な待機時間**を設けること。

---

## 3. 🛡️ エラーハンドリング必須実装

全てのAPI呼び出しスクリプトに、以下のロジックを**必須で**組み込め。

```python
MAX_RETRIES = 3
RETRY_DELAY_BASE = 30  # 最低30秒

for attempt in range(MAX_RETRIES):
    try:
        response = call_api(...)
        break  # 成功したらループ終了
    except RateLimitError:
        wait_time = RETRY_DELAY_BASE * (2 ** attempt)  # 指数バックオフ
        print(f"Rate limit hit. Waiting {wait_time}s...")
        time.sleep(wait_time)
    except Exception as e:
        log_error(e)
        break  # 致命的エラーは即終了
```

---

## 4. 📉 軽量化の徹底（Payload Reduction）

### 4.1 ファイル直接アップロードを避ける
PDFや画像を直接APIに投げると、トークン消費が膨大になる。代わりに：
1. `pdfplumber` や `PyMuPDF` でテキストを抽出
2. 抽出したテキストのみをAPIに送信
3. 必要であれば、要約してから送信

### 4.2 ファイル数の制限
1回のリクエストで送るファイルは**最大3件**に制限せよ。

---

## 5. 📊 使用量モニタリング（Runtime Monitoring）

### 5.1 ログ出力
各リクエストの成功/失敗をログに記録し、異常を早期検知せよ。

### 5.2 ダッシュボード確認
バッチ処理中は、Google AI Studio等のダッシュボードを定期的に確認し、429エラーの兆候があれば**即座に処理を停止**せよ。

---

## 6. 🔄 代替手段の準備（Fallback Strategy）

主要APIが制限に達した場合に備え、以下の代替手段を常に用意せよ：
1. **別のAPIキー/プロジェクト**: 複数のAPIキーをローテーション
2. **別のAIサービス**: Geminiがダメなら OpenAI や Claude を使う
3. **ローカル処理**: LLMを使わず、ルールベースで処理できる部分は切り出す

---

## 私が守る誓約

外部APIを使うバッチ処理を提案・実行する際、私は：
1. **事前に制限を確認**し、ユーザーに報告する
2. **1件ずつ段階的にテスト**してから大規模実行する
3. **エラーが出たら即座に停止**し、代替案を提示する
4. **「とりあえず全部回す」という行為を絶対にしない**

---
*このスキルは、2026年2月1日の失敗を教訓に作成された。*
