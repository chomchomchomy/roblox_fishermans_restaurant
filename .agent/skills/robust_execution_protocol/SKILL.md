---
name: Robust Execution & Admin Protocol (REAP)
description: 実行前の段取り徹底と、管理者権限が必要な操作を安全・確実に遂行するためのプロトコル。エラーを未然に防ぎ、実行の成功率を極限まで高めます。
---

# Robust Execution & Admin Protocol (REAP)

このスキルは、`scratch` 配下の全プロジェクトにおいて「エラーによる停止」を最小限に抑え、管理者権限が必要な操作をユーザーと協力して円滑に進めるための共通ガイドラインです。

## 1. 実行前の段取り（Pre-flight Checklist）
コマンドを実行する前に、以下の項目を必ずセルフチェックし、必要に応じて準備を行います。

### 1-1. 環境情報の確認
- **環境変数の確認**: `.env` ファイルやシステム環境変数がプロジェクトの要求を満たしているか。
- **依存関係の確認**: `pip list` や `npm list` を（必要なら非破壊的に）確認し、必要なパッケージが不足していないか。
- **パスの存在確認**: 読み書きするディレクトリやファイルが実際に存在するか、`list_dir`等で事前に確認する。

### 1-2. コマンドの妥当性検証
- **構文チェック**: 複雑なスクリプトやコマンドは、一度内容を精査し、タイポやパスの不一致がないか確認する。
- **破壊的影響の予測**: ファイル削除や上書きが伴う場合、バックアップや確認のステップを挟む。

### 1-3. 権限の事前判定
- **管理者権限の要否**: タスクスケジューラの操作、システムディレクトリへの書き込み、グローバル設定の変更など、管理者権限が必要な操作かどうかを事前に判断する。

### 1-4. 完全自律実行（Fully Autonomous Mode）
- **ユーザー承認済み**: ユーザーから「常時実行承認（Always allow）」の明示的な許可が得られているため、原則としてすべてのコマンド（`run_command`, `write_to_file`等）において `SafeToAutoRun: true` を設定する。
- **例外（Stop & Ask）**: 以下のケースのみ、安全のため意図的に `SafeToAutoRun: false` とし、ユーザーの確認を求める。
  - OSの再インストールやリカバリに関わる操作
  - 他の重要なプロセスを強制終了（Kill）する操作
  - 明らかに意図しない大量データの削除（`rm -rf /` 等の暴走防止）

### 1-5. スキルの整合性（Global-Local Link）
- **共有スキルの参照**: サブプロジェクトがルートの `.agent/skills` を認識しない場合、Windowsのジャンクション機能（`mklink /J`）を用いて、サブプロジェクトのスキルフォルダ内にルートへのリンクを作成し、常に最新の共通プロトコルが適用される状態を維持する。
- **重複の回避**: プロジェクト固有のスキルとルートの共通スキルが重複する場合、原則として「共通スキル」を優先、または「固有スキル」で必要な部分のみオーバーライドする。

## 2. 実行プロトコル（Execution Protocol）
Windows環境において、管理者権限（Elevated Privileges）が必要な操作、または重要なシステム変更を行う際の手順です。

### 2-1. ユーザーへの事前説明
- **理由の明記**: なぜ管理者権限が必要なのか（例：「Windowsタスクスケジューラへの登録にはシステム権限が必要です」）を明快に説明する。
- **同意の取得**: 「管理者権限で実行します。UAC（ユーザーアカウント制御）のポップアップが出る場合がありますので、承認をお願いします」と伝える。

### 2-2. PowerShellの実行
- **管理者モードの提案**: 必要に応じて、ユーザーに「管理者として実行したPowerShell」で特定のコマンドを叩くよう依頼するか、`run_command` で実行を試みる。
- **エラー時のフォロー**: 権限不足で失敗した（Access Denied等）場合、即座に「管理者権限での再実行」を提案し、具体的な手順を提示する。

## 3. PowerShell実行の鉄則（PowerShell Best Practices）
Windows環境のPowerShell実行において、エラーを最小化するための実装指針です。

### 3-1. エンコーディングと出力
- **UTF-8の強制**: 日本語を含む出力を正しくキャプチャするため、スクリプトの冒頭で `[Console]::OutputEncoding = [System.Text.Encoding]::UTF8` を実行することを推奨する。
- **パイプ処理**: `Select-String` などのフィルタリングを行う際、文字化けを防ぐためにエンコーディングを意識する。

### 3-2. クォートとエスケープ
- **複雑な文字列**: `run_command` で入れ子になったクォートを送る場合、ダブルクォートの二重化（`""`）や、可能な限りシングルクォート（`' '`）を外側に使うことでエスケープ失敗を防ぐ。
- **ヒアドキュメント**: 複雑なスクリプトを流し込む場合は、`@' ... '@`（ヒアドキュメント）の活用を検討する。

### 3-3. パスと存在確認
- **存在確認の徹底**: ファイルの読み書き・削除を行う前に、必ず `Test-Path` で対象の存在を確認する。
- **Join-Pathの利用**: 文字列結合によるパス生成を避け、`Join-Path` を使用することでバックスラッシュの重複や欠落を防ぐ。

### 3-4. エラーハンドリング
- **停止フラグ**: 重要な一連の処理を行う場合、`$ErrorActionPreference = "Stop"` を設定し、エラー発生時に後続のコマンドが暴走するのを防ぐ。
- **Try/Catch**: リカバリが必要な操作は `Try { ... } Catch { ... }` ブロックで囲み、エラー原因を明示的に出力する。

## 4. トラブルシューティング（Self-Healing）
- エラーが発生した場合は、出力されたエラーメッセージを精査し、上記の「段取り」や「鉄則」が守られていたか確認する。
- エンコーディング起因の文字化けや、クォートのエスケープミスが疑われる場合は、よりシンプルなコマンドに分割して再実行する。
