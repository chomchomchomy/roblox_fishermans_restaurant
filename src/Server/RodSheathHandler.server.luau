-- RodSheathHandler.server.luau
-- ç«¿ã‚’è£…å‚™ã—ã¦ã„ãªã„æ™‚ã«èƒŒä¸­ã«è¡¨ç¤ºã™ã‚‹æ¼”å‡º

local Players = game:GetService("Players")

-- èƒŒè² ã†ä½ç½®ã®å¾®èª¿æ•´ï¼ˆã“ã“ã‚’ã„ã˜ã‚‹ã¨è§’åº¦ã‚„ä½ç½®ãŒå¤‰ã‚ã‚‹ã‚ˆï¼ï¼‰
local BACK_OFFSET = CFrame.new(0, 0, 0.6) * CFrame.Angles(0, 0, math.rad(45)) 

local function updateSheath(player, character)
	local tool = player.Backpack:FindFirstChild("FishingRod") or character:FindFirstChild("FishingRod")
	if not tool then return end

	local handle = tool:FindFirstChild("Handle")
	if not handle then return end

	-- ã™ã§ã«èƒŒä¸­ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
	local existingSheath = character:FindFirstChild("BackRod")

	-- ç«¿ãŒæ‰‹ã«æŒãŸã‚Œã¦ã„ã‚‹ï¼ˆCharacterã®ä¸­ã«ã‚ã‚‹ï¼‰å ´åˆ
	if tool.Parent == character then
		if existingSheath then
			existingSheath:Destroy() -- èƒŒä¸­ã®ç«¿ã‚’æ¶ˆã™
		end
	else
		-- ç«¿ãŒã—ã¾ã‚ã‚Œã¦ã„ã‚‹ï¼ˆBackpackã®ä¸­ã«ã‚ã‚‹ï¼‰å ´åˆ
		if not existingSheath then
			-- èƒŒä¸­ã®ç«¿ã‚’ä½œæˆï¼ˆæœ¬ç‰©ã®Handleã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹ï¼‰
			local backRod = handle:Clone()
			backRod.Name = "BackRod"
			backRod.CanCollide = false
			backRod.CanTouch = false
			backRod.CanQuery = false
			
			-- ç«¿ã«ã¤ã„ã¦ã„ã‚‹éŸ³ã‚„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ­¢ã‚ã‚‹
			for _, child in pairs(backRod:GetChildren()) do
				if child:IsA("Script") or child:IsA("LocalScript") or child:IsA("Sound") then
					child:Destroy()
				end
			end
			
			backRod.Parent = character

			-- èƒŒä¸­ï¼ˆUpperTorsoï¼‰ã«ãã£ã¤ã‘ã‚‹
			local torso = character:WaitForChild("UpperTorso", 5) or character:WaitForChild("Torso", 5)
			if torso then
				local weld = Instance.new("Motor6D")
				weld.Name = "BackWeld"
				weld.Part0 = torso
				weld.Part1 = backRod
				weld.C0 = BACK_OFFSET
				weld.Parent = backRod
				print("ğŸ’ [" .. player.Name .. "] ãŒç«¿ã‚’èƒŒè² ã„ã¾ã—ãŸï¼")
			end
		end
	end
end

-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ãŸæ™‚ã®å‡¦ç†
Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function(character)
		-- è£…å‚™ãŒå¤‰ã‚ã£ãŸï¼ˆè¦ªãŒå¤‰ã‚ã£ãŸï¼‰ã®ã‚’ç›£è¦–ã™ã‚‹
		player.Backpack.ChildAdded:Connect(function() updateSheath(player, character) end)
		player.Backpack.ChildRemoved:Connect(function() updateSheath(player, character) end)
		character.ChildAdded:Connect(function() updateSheath(player, character) end)
		character.ChildRemoved:Connect(function() updateSheath(player, character) end)
		
		-- æœ€åˆã®ä¸€å›
		task.wait(1)
		updateSheath(player, character)
	end)
end)

-- ã™ã§ã«ã„ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”¨ï¼ˆStudioãƒ†ã‚¹ãƒˆç”¨ï¼‰
for _, player in pairs(Players:GetPlayers()) do
	if player.Character then
		updateSheath(player, player.Character)
	end
end
