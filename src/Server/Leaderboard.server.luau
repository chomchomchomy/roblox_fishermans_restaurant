-- Leaderboard.server.luau
-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆãŠé‡‘ãƒ»èƒ½åŠ›å€¤ãƒ»ã‚»ãƒ¼ãƒ–æ©Ÿèƒ½ï¼‰

local DataStoreService = game:GetService("DataStoreService")
local PlayerData = DataStoreService:GetDataStore("FishermansData_V1")
local Players = game:GetService("Players")

local function setupPlayer(player)
	-- leaderstats (å³ä¸Šã®è¡¨ç¤º)
	local leaderstats = Instance.new("Folder")
	leaderstats.Name = "leaderstats"
	leaderstats.Parent = player

	local money = Instance.new("IntValue")
	money.Name = "Money"
	money.Parent = leaderstats

	-- â˜…ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
	local success, data = pcall(function()
		return PlayerData:GetAsync(tostring(player.UserId))
	end)

	if success and data then
		-- ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°åæ˜ 
		money.Value = data.Money or 0
		player:SetAttribute("MaxStorage", data.MaxStorage or 5)
		player:SetAttribute("FishingSpeed", data.FishingSpeed or 1)
		player:SetAttribute("StoreStage", data.StoreStage or 0)
		print("ğŸ’¾ [" .. player.Name .. "] ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ")
	else
		-- åˆã‚ã¦ã®ãƒ—ãƒ¬ã‚¤ã€ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼æ™‚ã¯åˆæœŸå€¤
		money.Value = 0
		player:SetAttribute("MaxStorage", 5)
		player:SetAttribute("FishingSpeed", 1)
		player:SetAttribute("StoreStage", 0)
		print("ğŸ†• [" .. player.Name .. "] ã®æ–°è¦ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã—ãŸ")
	end
	
	-- æŒã¡ç‰©ç®¡ç†ç”¨ã®ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆéè¡¨ç¤ºï¼‰
	local bag = player:FindFirstChild("Bag") or Instance.new("Folder")
	bag.Name = "Bag"
	bag.Parent = player
end

-- â˜…ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ¼ãƒ–é–¢æ•°
local function savePlayer(player)
	local money = player.leaderstats.Money.Value
	local maxStorage = player:GetAttribute("MaxStorage")
	local fishingSpeed = player:GetAttribute("FishingSpeed")
	local storeStage = player:GetAttribute("StoreStage")

	local data = {
		Money = money,
		MaxStorage = maxStorage,
		FishingSpeed = fishingSpeed,
		StoreStage = storeStage
	}

	local success, err = pcall(function()
		PlayerData:SetAsync(tostring(player.UserId), data)
	end)

	if success then
		print("ğŸ’¾ [" .. player.Name .. "] ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ")
	else
		warn("âŒ [" .. player.Name .. "] ã®ä¿å­˜ã«å¤±æ•—: " .. err)
	end
end

-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ ãƒ»é€€å®¤ã‚¤ãƒ™ãƒ³ãƒˆ
Players.PlayerAdded:Connect(setupPlayer)
Players.PlayerRemoving:Connect(savePlayer)

-- Studioãƒ†ã‚¹ãƒˆç”¨ï¼ˆã™ã§ã«ã„ã‚‹äººã«å¯¾å¿œï¼‰
for _, player in pairs(Players:GetPlayers()) do
	setupPlayer(player)
end

-- ã‚µãƒ¼ãƒãƒ¼çµ‚äº†æ™‚ï¼ˆå…¨å“¡ä¿å­˜ï¼‰
game:BindToClose(function()
	for _, player in pairs(Players:GetPlayers()) do
		savePlayer(player)
	end
end)
