-- NPCManager.server.luau
-- StoreStageã«å¿œã˜ãŸNPCã®å‡ºç¾ã¨è‡ªå‹•åŒ–ãƒ­ã‚¸ãƒƒã‚¯ã®ç®¡ç†

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Shared = ReplicatedStorage:WaitForChild("Shared")
local FishData = require(Shared:WaitForChild("FishData"))

-- Chef NPCã®ç”Ÿæˆ (ç°¡å˜ãªãƒ€ãƒŸãƒ¼)
local function spawnChef(player)
    local stand = workspace:WaitForChild("FoodStand", 10)
    if not stand then return end

    -- ã™ã§ã«ã‚ã‚Œã°ä½•ã‚‚ã—ãªã„
    if stand:FindFirstChild("ChefNPC_" .. player.Name) then return end

    print("ğŸ‘¨â€ğŸ³ [" .. player.Name .. "] å°‚ç”¨ã®ã‚·ã‚§ãƒ•ã‚’å¬å–šã—ã¾ã™")

    local chef = Instance.new("Part")
    chef.Name = "ChefNPC_" .. player.Name
    chef.Size = Vector3.new(2, 5, 1)
    chef.Position = stand:FindFirstChild("SellCounter").Position + Vector3.new(-2, 3, -4)
    chef.Color = Color3.fromRGB(255, 200, 200)
    chef.Anchored = true
    chef.Parent = stand

    -- åå‰ã‚’è¡¨ç¤º
    local billboard = Instance.new("BillboardGui")
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.Adornee = chef
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.Parent = chef

    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, 0, 1, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = player.Name .. "ã®ãŠæŠ±ãˆã‚·ã‚§ãƒ•"
    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
    nameLabel.TextScaled = true
    nameLabel.Font = Enum.Font.LuckiestGuy
    nameLabel.Parent = billboard

    -- â˜…è‡ªå‹•èª¿ç†ãƒ»å£²å´ãƒ«ãƒ¼ãƒ—
    task.spawn(function()
        while chef and chef.Parent do
            task.wait(5) -- 5ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯

            local char = player.Character
            if not char then continue end

            -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¿‘ãï¼ˆ15ã‚¹ã‚¿ãƒƒãƒ‰ä»¥å†…ï¼‰ã«ã„ã‚‹æ™‚ã ã‘åƒã
            local dist = (char.PrimaryPart.Position - chef.Position).Magnitude
            if dist < 15 then
                local backpack = player:FindFirstChild("Backpack")
                local leaderstats = player:FindFirstChild("leaderstats")
                local money = leaderstats and leaderstats:FindFirstChild("Money")
                if not money or not backpack then continue end

                local totalValue = 0
                local count = 0

                -- é­šã‚’ã™ã¹ã¦ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã€Œãã®å ´ã§å£²å´ã€
                for _, item in pairs(backpack:GetChildren()) do
                    if item:IsA("Tool") and item.Name ~= "FishingRod" then
                        local val = item:GetAttribute("Value") or 10
                        -- ã‚·ã‚§ãƒ•è£œæ­£ï¼šç”Ÿé­šãªã‚‰2.5å€ã€ã™ã§ã«ç„¼ãé­šãªã‚‰ãã®ã¾ã¾ï¼ˆã¾ãŸã¯ã•ã‚‰ã«é«˜ãï¼Ÿï¼‰
                        -- ã“ã“ã§ã¯ã€Œã‚·ã‚§ãƒ•ãŒç„¼ã„ã¦å£²ã£ã¦ãã‚ŒãŸã€ã¨ã—ã¦ä¸€å¾‹2.5å€
                        totalValue += math.floor(val * 2.5)
                        count += 1
                        item:Destroy()
                    end
                end

                if count > 0 then
                    money.Value += totalValue
                    print("ğŸ³ ã‚·ã‚§ãƒ•ã®ãŠä»•äº‹: " .. count .. "åŒ¹ã‚’æ¥µä¸Šæ–™ç†ã«ã—ã¦å£²å´ï¼ +" .. totalValue .. "å††")
                    
                    -- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€šçŸ¥ï¼ˆFishingUIHandlerã®SELL_RESULTSã‚’å†åˆ©ç”¨ï¼‰
                    local fishingEvent = ReplicatedStorage:FindFirstChild("FishingEvent")
                    if fishingEvent then
                        fishingEvent:FireClient(player, "SELL_RESULTS", totalValue, count)
                    end
                end
            end
        end
    end)
end

-- å±æ€§å¤‰æ›´ã®ç›£è¦–
local function onPlayerAdded(player)
    player:GetAttributeChangedSignal("StoreStage"):Connect(function()
        local stage = player:GetAttribute("StoreStage") or 0
        if stage >= 1 then
            spawnChef(player)
        end
    end)
    
    -- æœ€åˆã‹ã‚‰Stage1ä»¥ä¸Šãªã‚‰å³åº§ã«
    if (player:GetAttribute("StoreStage") or 0) >= 1 then
        spawnChef(player)
    end
end

Players.PlayerAdded:Connect(onPlayerAdded)
for _, player in pairs(Players:GetPlayers()) do
    onPlayerAdded(player)
end
