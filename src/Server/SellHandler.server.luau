-- SellHandler.server.luau
-- å±‹å°ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã§é­šã‚’å£²å´ã™ã‚‹ä»•çµ„ã¿

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Shared = ReplicatedStorage:WaitForChild("Shared")
local FishData = require(Shared:WaitForChild("FishData"))
local remote = ReplicatedStorage:WaitForChild("FishingEvent")

-- ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æ¢ã™é–¢æ•°
local function setupSellCounter()
	local foodStand = workspace:WaitForChild("FoodStand", 10)
	if not foodStand then 
		warn("FoodStandãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚MapBuilderãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
		return 
	end

	-- æ—§åã®ã€ŒCounterã€ã¨æ–°åã®ã€ŒSellCounterã€ä¸¡æ–¹ã«å¯¾å¿œã™ã‚‹ã‚ˆã†ã«å·¥å¤«ã—ã¾ã™
	local counter = foodStand:FindFirstChild("SellCounter") or foodStand:FindFirstChild("Counter")
	
	if not counter then
		-- ã©ã†ã—ã¦ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€åå‰ã¯é•ã£ã¦ã‚‚ãã‚Œã£ã½ã„ãƒ‘ãƒ¼ãƒ„ã‚’æ¢ã™ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
		for _, child in pairs(foodStand:GetChildren()) do
			if child:IsA("BasePart") and child.Name:lower():find("count") then
				counter = child
				print("ğŸ’¡ åå‰ãŒå°‘ã—é•ã„ã¾ã™ãŒã€" .. child.Name .. " ã‚’ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã¨ã—ã¦èªè­˜ã—ã¾ã—ãŸã€‚")
				break
			end
		end
	end

	if not counter then
		warn("âŒ SellCounterãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å±‹å°ã®ä¸­ã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ç”¨ãƒ‘ãƒ¼ãƒ„ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
		return
	end

	-- ã™ã§ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã£ãŸã‚‰å‰Šé™¤
	local existing = counter:FindFirstChildOfClass("ProximityPrompt")
	if existing then existing:Destroy() end

	-- ProximityPromptã®è¨­å®š
	local prompt = Instance.new("ProximityPrompt")
	prompt.ActionText = "é­šã‚’å£²ã‚‹"
	prompt.ObjectText = "å±‹å°ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼"
	prompt.HoldDuration = 0.5
	prompt.KeyboardKeyCode = Enum.KeyCode.E
	prompt.Parent = counter

	-- å£²å´å‡¦ç†
	prompt.Triggered:Connect(function(player)
		local leaderstats = player:FindFirstChild("leaderstats")
		local money = leaderstats and leaderstats:FindFirstChild("Money")
		local backpack = player:FindFirstChild("Backpack")
		local character = player.Character

		if not money or not backpack then return end

		-- æŒã¡ç‰©ã‚’ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆBackpackã¨æ‰‹ã«æŒã£ã¦ã„ã‚‹ã‚‚ã®ä¸¡æ–¹ï¼‰
		local totalEarnings = 0
		local fishSold = 0
		local allItems = {}
		for _, item in pairs(backpack:GetChildren()) do table.insert(allItems, item) end
		if character then
			for _, item in pairs(character:GetChildren()) do table.insert(allItems, item) end
		end

		for _, item in pairs(allItems) do
			-- ç«¿ä»¥å¤–ã§ãŠé­šã®åå‰ãŒã¤ã„ã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’æ¢ã™
			if item:IsA("Tool") and item.Name ~= "FishingRod" then
				local price = item:GetAttribute("Value")
				
				-- AttributeãŒãªã„å ´åˆã¯åå‰ã‹ã‚‰æ¤œç´¢(äº’æ›æ€§ã®ãŸã‚)
				if not price then
					for _, data in pairs(FishData) do
						if data.name == item.Name then
							price = data.price
							break
						end
					end
				end
				
				if price then
					totalEarnings = totalEarnings + price
					fishSold = fishSold + 1
					item:Destroy() -- æ¶ˆå»ï¼ˆå£²å´ï¼‰
				end
			end
		end

		if fishSold > 0 then
			money.Value = money.Value + totalEarnings
			-- ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°
			print("ğŸ’° [" .. player.Name .. "] ãŒ " .. fishSold .. " åŒ¹ã®é­šã‚’å£²å´ã—ã€" .. totalEarnings .. "å††ç²å¾—ã—ã¾ã—ãŸï¼")
			
			-- â˜…NEWï¼šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å£²å´æˆåŠŸã‚’é€šçŸ¥ï¼ˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ï¼‰
			remote:FireClient(player, "SELL_RESULTS", totalEarnings, fishSold)
		else
			print("â„¹ï¸ [" .. player.Name .. "] ã¯å£²ã‚‹ãŸã‚ã®é­šã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚")
		end
	end)
end

-- ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã«å°‘ã—å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œï¼ˆMapBuilderã®å®Œäº†ã‚’å¾…ã¤ï¼‰
task.spawn(function()
	task.wait(1)
	setupSellCounter()
end)
