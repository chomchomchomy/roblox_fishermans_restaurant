-- SellHandler.server.luau
-- ğŸ“ æ•™è‚²è€…ã®è§£èª¬ï¼šã‚·ã‚§ãƒ•ã«ç›´æ¥ã€Œé­šã‚’å£²ã‚‹ã€ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆåå‰åˆ¤å®šãƒ»å¹ãå‡ºã—å¯¾å¿œç‰ˆï¼‰

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Chat = game:GetService("Chat")
local Shared = ReplicatedStorage:WaitForChild("Shared")
local FishData = require(Shared:WaitForChild("FishData"))

-- å£²å´å‡¦ç†ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
local function setupChefSellLogic(chefModel)
    local targetPart = chefModel:FindFirstChild("HumanoidRootPart") or chefModel:FindFirstChild("Torso") or chefModel:FindFirstChild("UpperTorso") or chefModel:FindFirstChild("Head")
    
    if not targetPart then return end
    if targetPart:FindFirstChild("SellPrompt") then return end

    -- ãƒœã‚¿ãƒ³ï¼ˆProximityPromptï¼‰ã®ä½œæˆ
    local prompt = Instance.new("ProximityPrompt")
    prompt.Name = "SellPrompt"
    prompt.ActionText = "é­šã‚’å£²ã‚‹" 
    prompt.ObjectText = "ã‚·ã‚§ãƒ•"
    prompt.HoldDuration = 0.5
    prompt.MaxActivationDistance = 15
    prompt.RequiresLineOfSight = false
    prompt.Parent = targetPart

    -- ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
    prompt.Triggered:Connect(function(player)
        local leaderstats = player:FindFirstChild("leaderstats")
        local money = leaderstats and leaderstats:FindFirstChild("Money")
        local backpack = player:FindFirstChild("Backpack")
        
        if not money or not backpack then return end

        local totalEarnings = 0
        local fishCount = 0
        local items = backpack:GetChildren()
        
        local character = player.Character
        if character then
            for _, v in pairs(character:GetChildren()) do
                if v:IsA("Tool") then table.insert(items, v) end
            end
        end

        for _, item in pairs(items) do
            -- ğŸ“ æ•™è‚²è€…ã®ã‚³ãƒ„ï¼šã‚¢ã‚¤ãƒ†ãƒ åã«ã¯ã€Œ(0.5kg)ã€ãªã©ã®é‡ã•ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§
            -- æ–‡å­—åˆ—ã®éƒ¨åˆ†ä¸€è‡´ï¼ˆstring.findï¼‰ã‚’ä½¿ã£ã¦åˆ¤å®šã™ã‚‹ã‹ã€
            -- ã‚ã‚‹ã„ã¯ãƒ„ãƒ¼ãƒ«ã«è¨­å®šã•ã‚ŒãŸã€ŒValueã€å±æ€§ã‚’ç›´æ¥èª­ã¿å–ã‚Šã¾ã™ã€‚
            
            if item:IsA("Tool") and item.Name ~= "FishingRod" then
                local price = item:GetAttribute("Value") -- FishingHandlerã§è¨­å®šã—ãŸå£²å€¤
                
                if price then
                    -- å±æ€§ã‹ã‚‰ç›´æ¥ä¾¡æ ¼ã‚’å–å¾—ã§ããŸå ´åˆ
                    totalEarnings += price
                    fishCount += 1
                    item:Destroy()
                else
                    -- å±æ€§ãŒãªã„å ´åˆã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼šFishDataã‹ã‚‰åå‰ã‚’æ¢ã™
                    for _, data in pairs(FishData) do
                        -- åå‰ã®ä¸€éƒ¨ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹ï¼šã€Œã‚¢ã‚¸ã€ãŒã€Œã‚¢ã‚¸ (0.4kg)ã€ã«å«ã¾ã‚Œã‚‹ã‹ï¼‰
                        if string.find(item.Name, data.name) then
                            totalEarnings += data.price
                            fishCount += 1
                            item:Destroy()
                            break
                        end
                    end
                end
            end
        end

        if fishCount > 0 then
            money.Value += totalEarnings
            -- æˆåŠŸæ™‚ã®å¹ãå‡ºã—
            local msg = "æ¯åº¦ï¼" .. fishCount .. "åŒ¹ã§ " .. totalEarnings .. " Goldã ï¼"
            Chat:Chat(chefModel:FindFirstChild("Head") or targetPart, msg, Enum.ChatColor.White)
            print("ğŸ’° [å£²è²·æˆç«‹] ã‚·ã‚§ãƒ•ã€Œ" .. msg .. "ã€")
        else
            -- ã€ç¤¾é•·ã‚ªãƒ¼ãƒ€ãƒ¼ã€‘é­šã‚’æŒã£ã¦ã„ãªã„æ™‚
            local failMsg = "ãŠã‚„ã€å£²ã‚Œã‚‹é­šã‚’æŒã£ã¦ã„ãªã„ã‚ˆã†ã ã‚ˆã€‚"
            Chat:Chat(chefModel:FindFirstChild("Head") or targetPart, failMsg, Enum.ChatColor.White)
            print("ğŸ‘¨â€ğŸ³ [ã‚·ã‚§ãƒ•] ã€Œ" .. failMsg .. "ã€")
        end
    end)
end

-- ç›£è¦–ãƒ«ãƒ¼ãƒ—
task.spawn(function()
    while true do
        local chef = workspace:FindFirstChild("Chef")
        if chef then
            setupChefSellLogic(chef)
        end
        task.wait(2)
    end
end)

print("ğŸ‘¨â€ğŸ³ [SellHandler] ååˆ¤å®šãƒ»å¹ãå‡ºã—å¯¾å¿œã‚·ã‚¹ãƒ†ãƒ ã€å®Œå…¨ç¨¼åƒï¼")
