-- SellHandler.server.luau
-- ğŸ“ æ•™è‚²è€…ã®è§£èª¬ï¼šã‚·ã‚§ãƒ•ã«ç›´æ¥ã€Œé­šã‚’å£²ã‚‹ã€ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Shared = ReplicatedStorage:WaitForChild("Shared")
local FishData = require(Shared:WaitForChild("FishData"))

-- å£²å´å‡¦ç†ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
local function setupChefSellLogic(chefModel)
    local rootPart = chefModel:WaitForChild("HumanoidRootPart", 5)
    if not rootPart then return end
    
    if rootPart:FindFirstChild("SellPrompt") then return end

    -- ã‚·ã‚§ãƒ•è‡ªèº«ã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    local prompt = Instance.new("ProximityPrompt")
    prompt.Name = "SellPrompt"
    prompt.ActionText = "é­šã‚’ã‚·ã‚§ãƒ•ã«æ¸¡ã™"
    prompt.ObjectText = "ã‚·ã‚§ãƒ•"
    prompt.HoldDuration = 0.5
    prompt.Parent = rootPart

    prompt.Triggered:Connect(function(player)
        local leaderstats = player:FindFirstChild("leaderstats")
        local money = leaderstats and leaderstats:FindFirstChild("Money")
        local backpack = player:FindFirstChild("Backpack")
        
        if not money or not backpack then return end

        local totalEarnings = 0
        local fishCount = 0
        
        -- æ‰‹æŒã¡ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒã‚§ãƒƒã‚¯
        local items = backpack:GetChildren()
        local character = player.Character
        if character then
            for _, v in pairs(character:GetChildren()) do
                if v:IsA("Tool") then table.insert(items, v) end
            end
        end

        for _, item in pairs(items) do
            if item:IsA("Tool") and item.Name ~= "FishingRod" then
                for _, data in pairs(FishData) do
                    if data.name == item.Name then
                        totalEarnings += data.price
                        fishCount += 1
                        item:Destroy()
                        break
                    end
                end
            end
        end

        if fishCount > 0 then
            money.Value += totalEarnings
            print("ğŸ‘¨â€ğŸ³ [ã‚·ã‚§ãƒ•] ã€Œã„ã„é­šã ï¼" .. totalEarnings .. " Gold ã§è²·ã„å–ã‚‰ã›ã¦ã‚‚ã‚‰ã†ã‚ˆï¼ã€")
        else
            print("ğŸ‘¨â€ğŸ³ [ã‚·ã‚§ãƒ•] ã€ŒãŠã‚„ã€å£²ã‚Œã‚‹é­šã‚’æŒã£ã¦ã„ãªã„ã‚ˆã†ã ã­ã€‚ã€")
        end
    end)
end

-- å¸¸ã«ã€Œã‚·ã‚§ãƒ•ã€ãŒä¸–ç•Œã«ã„ã‚‹ã‹ç›£è¦–ã™ã‚‹
task.spawn(function()
    while true do
        local chef = workspace:FindFirstChild("Chef")
        if chef then
            setupChefSellLogic(chef)
        end
        task.wait(2)
    end
end)

print("ğŸ‘¨â€ğŸ³ [SellHandler] ã‚·ã‚§ãƒ•ã®è²·ã„å–ã‚Šå—ä»˜ã‚·ã‚¹ãƒ†ãƒ ã€èµ·å‹•ï¼")
