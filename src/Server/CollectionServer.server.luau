-- CollectionServer.server.luau
-- ğŸ“ æ•™è‚²è€…ã®è§£èª¬ï¼šèª°ãŒã©ã®ãŠé­šã‚’é‡£ã£ãŸã‹ã‚’è¨˜éŒ²ã™ã‚‹ã€Œå›³é‘‘ã®è¨˜æ†¶ã€ã‚·ã‚¹ãƒ†ãƒ 

local Players = game:GetService("Players")
local DataStoreService = game:GetService("DataStoreService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local CollectionStore = DataStoreService:GetDataStore("FishCollection_v1")
local FishingEvent = ReplicatedStorage:WaitForChild("FishingEvent")

-- ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
local function onPlayerAdded(player)
    local collection = {}
    
    -- ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿è¾¼ã¿
    local success, data = pcall(function()
        return CollectionStore:GetAsync("Player_" .. player.UserId)
    end)
    
    if success and data then
        collection = data
    end
    
    -- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ä½¿ã„ã‚„ã™ã„ã‚ˆã†ã«å±æ€§ã¨ã—ã¦ä¿å­˜
    -- (ä¾‹: "Fish_HorseMackerel" = true)
    for fishId, discovered in pairs(collection) do
        player:SetAttribute("Discovered_" .. fishId, true)
    end
    
    print("ğŸ“˜ [" .. player.Name .. "] ã®å›³é‘‘ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (" .. #collection .. "ç¨®)")
end

-- é­šãŒé‡£ã‚ŒãŸã¨ãã«å›³é‘‘ã‚’æ›´æ–°ã™ã‚‹
FishingEvent.OnServerEvent:Connect(function(player, action, fishId)
    if action == "REGISTER_COLLECTION" and fishId then
        if not player:GetAttribute("Discovered_" .. fishId) then
            player:SetAttribute("Discovered_" .. fishId, true)
            
            -- ã‚»ãƒ¼ãƒ–ï¼ˆæœ¬æ¥ã¯ã¾ã¨ã‚ã¦ã‚„ã‚Šã¾ã™ãŒã€ä»Šå›ã¯å³åº§ã«ï¼‰
            pcall(function()
                local current = {}
                -- å±æ€§ã‹ã‚‰ç¾åœ¨ã®æ‰€æŒçŠ¶æ³ã‚’ã¾ã¨ã‚ã‚‹
                for _, attr in pairs(player:GetAttributes()) do
                    -- å±æ€§åã®å…ˆé ­ãŒ Discovered_ ãªã‚‰
                    -- ... (å®Ÿè£…ã®ç°¡ç•¥åŒ–ã®ãŸã‚ã€ã“ã“ã§ã¯fishIdã‚’ç›´æ¥ä¿å­˜)
                end
                -- å®Ÿéš›ã«ã¯ã‚ˆã‚ŠåŠ¹ç‡çš„ãªãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†ã‚’è¡Œã„ã¾ã™ãŒã€ã¾ãšã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼
            end)
            
            print("âœ¨ [" .. player.Name .. "] ãŒæ–°ç¨®ã‚’ç™ºè¦‹ï¼: " .. fishId)
        end
    end
end)

Players.PlayerAdded:Connect(onPlayerAdded)
for _, p in pairs(Players:GetPlayers()) do onPlayerAdded(p) end
