-- CookerHandler.server.luau
-- ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³å†…ã§ã®èª¿ç†ãƒ»è‡ªå‹•å£²å´ã‚·ã‚¹ãƒ†ãƒ  (é€²åŒ–å¯¾å¿œç‰ˆ)

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Shared = ReplicatedStorage:WaitForChild("Shared")
local FishData = require(Shared:WaitForChild("FishData"))

local function setupRestaurantLogic(grill)
    if grill:FindFirstChild("CookPrompt") then return end

    local smoke = grill:FindFirstChildOfClass("Smoke")
    local fire = grill:FindFirstChildOfClass("ParticleEmitter") or Instance.new("ParticleEmitter", grill)
    fire.Texture = "rbxassetid://241539266"
    fire.Rate = 0

    local prompt = Instance.new("ProximityPrompt", grill)
    prompt.Name = "CookPrompt"
    prompt.ActionText = "é­šã‚’èª¿ç†ã—ã¦å£²ã‚‹"
    prompt.ObjectText = "æœ€æ–°é‹­ã‚°ãƒªãƒ«"
    prompt.HoldDuration = 2.0

    prompt.Triggered:Connect(function(player)
        local backpack = player:FindFirstChild("Backpack")
        local char = player.Character
        local items = {}
        for _, i in pairs(backpack:GetChildren()) do if i:IsA("Tool") and i.Name ~= "FishingRod" then table.insert(items, i) end end
        if char then
            for _, i in pairs(char:GetChildren()) do if i:IsA("Tool") and i.Name ~= "FishingRod" then table.insert(items, i) end end
        end

        if #items > 0 then
            print("ğŸ³ [" .. player.Name .. "] ãŒèª¿ç†ã‚’é–‹å§‹ã—ã¾ã—ãŸ...")
            if smoke then smoke.Enabled = true end
            fire.Rate = 50
            task.wait(3)

            local totalEarn = 0
            for _, fish in pairs(items) do
                local price = 10
                for _, data in pairs(FishData) do
                    if data.name == fish.Name then price = data.price break end
                end
                totalEarn += math.floor(price * 1.5)
                fish:Destroy()
            end

            local leaderstats = player:FindFirstChild("leaderstats")
            local money = leaderstats and leaderstats:FindFirstChild("Money")
            if money then
                money.Value += totalEarn
                print("ğŸ’° èª¿ç†å®Œäº†ï¼ 1.5å€ï¼ˆ" .. totalEarn .. "å††ï¼‰ç²å¾—")
            end
            if smoke then smoke.Enabled = false end
            fire.Rate = 0
        end
    end)
end

-- ç›£è¦–ãƒ«ãƒ¼ãƒ—
task.spawn(function()
    while true do
        local stand = workspace:FindFirstChild("FoodStand")
        local grill = stand and stand:FindFirstChild("CookingStation")
        if grill then
            setupRestaurantLogic(grill)
        end
        task.wait(2)
    end
end)
