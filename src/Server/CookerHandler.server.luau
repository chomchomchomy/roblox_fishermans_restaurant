-- CookerHandler.server.luau
-- ğŸ“ æ•™è‚²è€…ã®è§£èª¬ï¼šç„šãç«ã§ãŠé­šã‚’ç„¼ããŸã‚ã®é­”æ³•ï¼ˆè¶…ãƒ»å®‰å®šç‰ˆï¼‰

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Shared = ReplicatedStorage:WaitForChild("Shared")
local FishData = require(Shared:WaitForChild("FishData"))

local COOK_TIME = 5

local function setupBonfireLogic()
    -- æ¢ã—æ–¹ã‚’ã•ã‚‰ã«ç¢ºå®Ÿã«ã—ã¾ã™
    local bonfire = workspace:FindFirstChild("Bonfire", true)
    
    if not bonfire then 
        -- ã‚‚ã—ãªã‘ã‚Œã°ã€FoodStandã®ä¸­ã‚’ç›´æ¥æ¢ã™
        local fs = workspace:FindFirstChild("FoodStand")
        bonfire = fs and fs:FindFirstChild("Bonfire")
    end
    
    if not bonfire then return end
    if bonfire:FindFirstChild("CookPrompt") then return end

    print("ğŸ”¥ [Cooker] ç„šãç«ã‚’æ¤œçŸ¥ï¼èª¿ç†ãƒœã‚¿ãƒ³ã‚’è£…ç€ã—ã¾ã™ã€‚")

    local prompt = Instance.new("ProximityPrompt")
    prompt.Name = "CookPrompt"
    prompt.ActionText = "é­šã‚’ç„¼ã"
    prompt.ObjectText = "ç„šãç«"
    prompt.HoldDuration = 0.5
    prompt.MaxActivationDistance = 12
    prompt.RequiresLineOfSight = false
    prompt.Parent = bonfire

    prompt.Triggered:Connect(function(player)
        local backpack = player:FindFirstChild("Backpack")
        if not backpack then return end

        local fishToCook = nil
        -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹ã«æŒã£ã¦ã„ã‚‹ã‚‚ã®ã€ã¾ãŸã¯ã‚«ãƒãƒ³ã®ä¸­ã‚’ç¢ºèª
        local items = player.Character:GetChildren()
        for _, v in pairs(backpack:GetChildren()) do table.insert(items, v) end

        for _, item in pairs(items) do
            if item:IsA("Tool") and item.Name ~= "FishingRod" and not item:GetAttribute("IsCooked") then
                fishToCook = item
                break
            end
        end

        if fishToCook then
            local originalName = fishToCook.Name
            local originalPrice = fishToCook:GetAttribute("Value") or 10
            fishToCook:Destroy()

            prompt.Enabled = false
            prompt.ActionText = "ğŸ”¥ ã‚¸ãƒ¥ãƒ¼ãƒ¼ãƒƒ..."
            
            task.wait(COOK_TIME)

            -- ç„¼ãä¸ŠãŒã‚Šã®ç”Ÿæˆ
            local grilled = Instance.new("Tool")
            grilled.Name = "ğŸ”¥ ç„¼ã" .. originalName
            grilled.ToolTip = "é¦™ã°ã—ãç„¼ã‘ãŸé­šï¼"
            grilled:SetAttribute("IsCooked", true)
            grilled:SetAttribute("Value", math.floor(originalPrice * 2.0))
            grilled.RequiresHandle = false
            
            -- ç”»åƒã®å¼•ç¶™ã
            for _, data in pairs(FishData) do
                if string.find(originalName, data.name) then
                    grilled.TextureId = data.imageId
                    break
                end
            end
            
            grilled.Parent = backpack
            prompt.Enabled = true
            prompt.ActionText = "é­šã‚’ç„¼ã"
            print("âœ… ç„¼ãä¸ŠãŒã‚Šã¾ã—ãŸï¼: " .. grilled.Name)
        else
            print("âŒ ç„¼ã‘ã‚‹é­šã‚’æŒã£ã¦ã„ã¾ã›ã‚“")
        end
    end)
end

task.spawn(function()
    while true do
        setupBonfireLogic()
        task.wait(2)
    end
end)
