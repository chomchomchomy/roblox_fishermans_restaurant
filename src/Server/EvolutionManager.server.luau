-- EvolutionManager.server.luau
-- åº—èˆ—ã®é€²åŒ–ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰ã‚’ç®¡ç†ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Shared = ReplicatedStorage:WaitForChild("Shared")
local MapBuilder = require(Shared:WaitForChild("MapBuilder"))

-- å…¨ã¦ã® ProximityPrompt ã‚’ç›£è¦–ã™ã‚‹
game:GetService("ProximityPromptService").PromptTriggered:Connect(function(prompt, player)
    local board = prompt.Parent
    if board.Name ~= "UpgradeBoard" then return end

    local costStr = string.match(board:FindFirstChildOfClass("SurfaceGui").TextLabel.Text, "è²»ç”¨: (%d+)")
    local cost = tonumber(costStr) or 0
    local nextStage = tonumber(string.match(prompt.ActionText, "Stage (%d+)")) or 1
    local buildingType = prompt.ObjectText -- "Restaurant" or "Shop"

    local leaderstats = player:FindFirstChild("leaderstats")
    local money = leaderstats and leaderstats:FindFirstChild("Money")

    if money and money.Value >= cost then
        -- æ”¯æ‰•ã„
        money.Value -= cost
        print("ğŸ‰ [" .. player.Name .. "] ãŒ " .. buildingType .. " ã‚’ Stage " .. nextStage .. " ã«é€²åŒ–ã•ã›ã¾ã—ãŸï¼")

        -- æ¼”å‡º
        MapBuilder.playUpgradeEffect(board.Position)

        -- å»ºç¯‰
        if buildingType == "Restaurant" then
            MapBuilder.buildRestaurant(nextStage)
        elseif buildingType == "Shop" then
            MapBuilder.buildUpgradeShop(nextStage)
        end
        
        -- å¤ã„ãƒœãƒ¼ãƒ‰ã¯å»ºç¯‰é–¢æ•°å†…ã§ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨æ¶ˆãˆã‚‹ã®ã§OK
    else
        print("âŒ ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ (å¿…è¦: " .. cost .. ")")
    end
end)

print("ğŸ¢ [EvolutionManager] ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ã€‚ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æŠ•è³‡ã‚’å¾…æ©Ÿä¸­...")
