-- ShopHandler.server.luau
-- é‡£å…·å±‹ã§ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‡¦ç†

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local fishingEvent = ReplicatedStorage:WaitForChild("FishingEvent")

-- â˜…NEWï¼šã‚·ãƒ§ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã®ä½œæˆ
local shopEvent = ReplicatedStorage:FindFirstChild("ShopEvent")
if not shopEvent then
    shopEvent = Instance.new("RemoteEvent")
    shopEvent.Name = "ShopEvent"
    shopEvent.Parent = ReplicatedStorage
end

-- ã‚·ãƒ§ãƒƒãƒ—ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æ¢ã™
local function setupShopCounter()
    local shop = workspace:WaitForChild("UpgradeShop", 10)
    if not shop then 
        warn("UpgradeShopãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        return 
    end

    local counter = shop:FindFirstChild("UpgradeCounter")
    if not counter then
        warn("UpgradeCounterãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        return
    end

    -- è¿‘æ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¨­å®š
    local prompt = Instance.new("ProximityPrompt")
    prompt.ActionText = "ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰"
    prompt.ObjectText = "ä¼èª¬ã®é‡£å…·å±‹"
    prompt.HoldDuration = 0.5
    prompt.KeyboardKeyCode = Enum.KeyCode.E
    prompt.Parent = counter

    -- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Ÿè¡Œæ™‚
    prompt.Triggered:Connect(function(player)
        print("ğŸ›’ [" .. player.Name .. "] ãŒã‚·ãƒ§ãƒƒãƒ—ã‚’é–‹ãã¾ã—ãŸ")
        shopEvent:FireClient(player, "OPEN")
    end)
end

local RodData = require(ReplicatedStorage:WaitForChild("Shared"):WaitForChild("RodData"))

-- è³¼å…¥å‡¦ç†
shopEvent.OnServerEvent:Connect(function(player, action, itemType)
    local leaderstats = player:FindFirstChild("leaderstats")
    local money = leaderstats and leaderstats:FindFirstChild("Money")
    if not money then return end

    if action == "BUY_UPGRADE" then
        if itemType == "FISHING_SPEED" then
            local currentLevel = player:GetAttribute("FishingSpeedLevel") or 1
            local cost = currentLevel * 500
            
            if money.Value >= cost then
                money.Value -= cost
                player:SetAttribute("FishingSpeedLevel", currentLevel + 1)
                
                -- ã™ã§ã«ã‚ã‚‹å€ç‡ã«ã•ã‚‰ã«0.9å€ï¼ˆ10%é€Ÿãï¼‰
                local currentSpeed = player:GetAttribute("FishingSpeed") or 1.0
                player:SetAttribute("FishingSpeed", currentSpeed * 0.9)
                
                print("ğŸ’° [" .. player.Name .. "] ä¿®è¡Œã«ã‚ˆã‚Šé‡£ã‚Šã®é€Ÿåº¦ãŒå‘ä¸Šï¼")
                shopEvent:FireClient(player, "SUCCESS", "FISHING_SPEED")
            end
        elseif itemType == "BAG_SIZE" then
            local currentLevel = player:GetAttribute("BagLevel") or 1
            local cost = currentLevel * 400
            
            if money.Value >= cost then
                money.Value -= cost
                player:SetAttribute("BagLevel", currentLevel + 1)
                local newSize = 5 + (currentLevel * 5)
                player:SetAttribute("MaxStorage", newSize)
                
                print("ğŸ’° [" .. player.Name .. "] ãƒãƒƒã‚°æ‹¡å¼µå®Œäº†(å®¹é‡: " .. newSize .. ")")
                shopEvent:FireClient(player, "SUCCESS", "BAG_SIZE")
            end
        end
    elseif action == "BUY_ROD" then
        local currentTier = player:GetAttribute("RodTier") or 1
        local nextTier = currentTier + 1
        local rodInfo = RodData[nextTier]

        if rodInfo and money.Value >= rodInfo.price then
            money.Value -= rodInfo.price
            player:SetAttribute("RodTier", nextTier)
            player:SetAttribute("FishingSpeed", rodInfo.speed)
            player:SetAttribute("RarityBoost", rodInfo.rarityBoost)
            
            -- ç«¿ã®è¦‹ãŸç›®ã‚’å¤‰ãˆã‚‹ãŸã‚ã«å±æ€§ã‚»ãƒƒãƒˆ
            player:SetAttribute("RodColor", rodInfo.color)
            
            print("ğŸ’° [" .. player.Name .. "] ãŒ " .. rodInfo.name .. " ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼")
            shopEvent:FireClient(player, "SUCCESS", "ROD", nextTier)
        end
    end
end)

task.spawn(function()
    task.wait(1)
    setupShopCounter()
end)
