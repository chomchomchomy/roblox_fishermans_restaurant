-- CustomerManager.server.luau
-- ğŸ“ æ•™è‚²è€…ã®è§£èª¬ï¼šãŠåº—ã«ãŠå®¢ã•ã‚“ã‚’å‘¼ã³è¾¼ã‚€ãŸã‚ã®é­”æ³•ï¼ˆNPCã‚¹ãƒãƒŠãƒ¼ï¼‰

local Players = game:GetService("Players")
local Chat = game:GetService("Chat")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- è¨­å®š
local CUSTOMER_IDS = {
    1,          -- Roblox (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
    286241773,  -- ãƒ—ãƒ­é‡£ã‚Šå¸«é¢¨
    156,        -- ã‚·ãƒ³ãƒ—ãƒ«ãªäºº
    161044319,  -- è¦³å…‰å®¢é¢¨
}
local SPAWN_INTERVAL = 20 -- 20ç§’ã”ã¨ã«ãŠå®¢ã•ã‚“ãŒæ¥ã‚‹

-- ãŠå®¢ã•ã‚“ã‚’ä¸€äººä½œæˆã™ã‚‹é–¢æ•°
local function spawnCustomer()
    local foodStand = workspace:FindFirstChild("FoodStand")
    local basePos = Vector3.new(40, 1.5, 90) -- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆç„šãç«ï¼‰ã®ä½ç½®
    
    if foodStand then
        if foodStand:IsA("Model") then
            basePos = foodStand:GetPivot().Position
        elseif foodStand:IsA("BasePart") then
            basePos = foodStand.Position
        elseif foodStand:IsA("Folder") then
            -- ç„šãç«ãƒ•ã‚©ãƒ«ãƒ€ã®å ´åˆã€ä¸­èº«ã®Bonfireã‚’æ¢ã™
            local b = foodStand:FindFirstChild("Bonfire") or foodStand:FindFirstChildWhichIsA("BasePart")
            if b then basePos = b.Position end
        end
    end
    
    -- å‡ºç¾ä½ç½®ï¼ˆå±‹å°ã‹ã‚‰å°‘ã—é›¢ã‚ŒãŸå ´æ‰€ï¼‰
    local spawnPos = basePos + Vector3.new(math.random(-30, 30), 0, 40)
    -- å¾…ã¡åˆã‚ã›å ´æ‰€ï¼ˆå±‹å°ã®çœŸã‚“å‰ï¼‰
    local targetPos = basePos + Vector3.new(math.random(-5, 5), 0, 10)

    -- ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¢ãƒã‚¿ãƒ¼ã§ãŠå®¢ã•ã‚“ã‚’ä½œæˆ
    local userId = CUSTOMER_IDS[math.random(#CUSTOMER_IDS)]
    local customer
    local success, err = pcall(function()
        customer = Players:CreateHumanoidModelFromUserId(userId)
    end)
    
    if not success or not customer then return end
    
    customer.Name = "Customer"
    customer.Parent = workspace
    customer:PivotTo(CFrame.new(spawnPos))
    
    -- åå‰ã‚’ã€ŒãŠè…¹ã‚’ç©ºã‹ã›ãŸãŠå®¢ã•ã‚“ã€ã«ã™ã‚‹
    local hum = customer:FindFirstChildOfClass("Humanoid")
    if hum then
        hum.DisplayName = "ãŠè…¹ã‚’ç©ºã‹ã›ãŸãŠå®¢ã•ã‚“"
        -- å±‹å°ã¾ã§æ­©ã‹ã›ã‚‹ï¼
        task.wait(1)
        hum:MoveTo(targetPos)
        
        -- åˆ°ç€å¾…ã¡
        hum.MoveToFinished:Connect(function()
            -- åˆ°ç€ã—ãŸã‚‰å¹ãå‡ºã—ã§å–‹ã‚‹
            Chat:Chat(customer.Head, "ã„ã„åŒ‚ã„ã ãªã€‚ç„¼ãé­šã‚’ãã‚Œãªã„ã‹ï¼Ÿ", Enum.ChatColor.Blue)
            
            -- ã€ç¤¾é•·ã‚ªãƒ¼ãƒ€ãƒ¼ã¸ã®å¸ƒçŸ³ã€‘å£²å´ç”¨ã®ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            local targetPart = customer:FindFirstChild("HumanoidRootPart") or customer.PrimaryPart
            if targetPart then
                local prompt = Instance.new("ProximityPrompt", targetPart)
                prompt.ActionText = "ç„¼ãé­šã‚’å£²ã‚‹"
                prompt.ObjectText = "ãŠå®¢ã•ã‚“"
                prompt.HoldDuration = 0.5
                
                -- ãŠå®¢ã•ã‚“ã«å£²ã‚‹å‡¦ç†ï¼ˆã‚¹ãƒ†ãƒƒãƒ—4ã«é–¢é€£ï¼‰
                prompt.Triggered:Connect(function(player)
                    local backpack = player:FindFirstChild("Backpack")
                    local cookedFish = nil
                    
                    -- ç„¼ãé­šã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    for _, item in pairs(backpack:GetChildren()) do
                        if item:IsA("Tool") and item:GetAttribute("IsCooked") then
                            cookedFish = item
                            break
                        end
                    end
                    
                    if cookedFish then
                        local price = cookedFish:GetAttribute("Value") or 50
                        local leaderstats = player:FindFirstChild("leaderstats")
                        local money = leaderstats and leaderstats:FindFirstChild("Money")
                        if money then money.Value += price end
                        
                        Chat:Chat(customer.Head, "ã†ã¾ã„ï¼" .. price .. " Goldæ‰•ã†ã‚ˆï¼", Enum.ChatColor.Green)
                        cookedFish:Destroy()
                        prompt:Destroy()
                        
                        -- æº€è¶³ã—ã¦å¸°ã‚‹
                        task.wait(2)
                        hum:MoveTo(spawnPos)
                        hum.MoveToFinished:Connect(function() customer:Destroy() end)
                    else
                        Chat:Chat(customer.Head, "ç„¼ãé­šãŒé£Ÿã¹ãŸã„ã‚“ã ...", Enum.ChatColor.Red)
                    end
                end)
            end
        end)
    end
end

-- å®šæœŸçš„ã«å‘¼ã³å‡ºã™ï¼ˆã‚²ãƒ¼ãƒ é–‹å§‹ã—ã¦å°‘ã—å¾…ã£ã¦ã‹ã‚‰ï¼‰
task.delay(10, function()
    while true do
        spawnCustomer()
        task.wait(SPAWN_INTERVAL)
    end
end)

print("ğŸš¶â€â™‚ï¸ [CustomerManager] ãŠå®¢ã•ã‚“æ¥åº—ã‚·ã‚¹ãƒ†ãƒ ã€æº–å‚™å®Œäº†ï¼")
