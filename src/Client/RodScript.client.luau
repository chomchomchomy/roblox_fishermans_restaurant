-- [Rojoç®¡ç†] ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯VS Codeï¼ˆAntigravityï¼‰ã§ç·¨é›†ã—ã¦ã­ï¼
-- FishingRod > RodScript (LocalScript)
local tool = script.Parent
local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart")
local mouse = player:GetMouse()
local isFishing = false
local isBiting = false -- â˜…NEWï¼šé­šãŒé£Ÿã„ã¤ã„ã¦ã„ã‚‹æœ€ä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

-- ãƒªã‚½ãƒ¼ã‚¹ã®å–å¾—
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local remote = ReplicatedStorage:WaitForChild("FishingEvent")
local throwSound = game:GetService("SoundService"):WaitForChild("ThrowSound")

-- ãƒ‘ãƒ¼ãƒ„é¡
local handle = tool:WaitForChild("Handle")
local beam = handle:WaitForChild("Beam")
local rodTip = handle:WaitForChild("RodTip")

-- HookPosã®è‡ªå‹•ä½œæˆï¼ˆç³¸ã®å…ˆç«¯ã‚’å›ºå®šã™ã‚‹å ´æ‰€ï¼‰
local hookPos = handle:FindFirstChild("HookPos")
if not hookPos then
	hookPos = Instance.new("Attachment")
	hookPos.Name = "HookPos"
	hookPos.Parent = workspace.Terrain -- ä¸–ç•Œå´ã«é…ç½®
end

-- ã‚°ãƒªãƒƒãƒ—è¨­å®š
local normalGrip = CFrame.new(0, -3.7, 0) -- é€šå¸¸æ™‚ï¼ˆæ•°å­—ã¯ãƒ¢ãƒ‡ãƒ«ã«åˆã‚ã›ã¦å¾®èª¿æ•´ã—ã¦ãã ã•ã„ï¼‰
local swingGrip = normalGrip * CFrame.Angles(math.rad(60), 0, 0) -- æŠ•ã’ãŸæ™‚ã®è§’åº¦

-- åˆæœŸåŒ–
tool.Grip = normalGrip
beam.Attachment0 = rodTip
beam.Attachment1 = hookPos
beam.Enabled = false

-- â˜…ç«¿ã®å…ˆç«¯ã‚’ç‰¹å®šã™ã‚‹é–¢æ•°
local function updateRodTip()
	local size = handle.Size
	if size.X > size.Y and size.X > size.Z then
		rodTip.Position = Vector3.new(size.X/2, 0, 0)
	elseif size.Y > size.X and size.Y > size.Z then
		rodTip.Position = Vector3.new(0, size.Y/2, 0)
	else
		rodTip.Position = Vector3.new(0, 0, -size.Z/2) -- ç«¿ã®å‘ãã«åˆã‚ã›ã¦ãƒã‚¤ãƒŠã‚¹èª¿æ•´
	end
end

-- ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†
tool.Activated:Connect(function()
	if isFishing then return end

	local target = mouse.Target
	
	-- â˜…ãƒ—ãƒ­ã®é­”æ³•ï¼šç´ æãŒã€Œæ°´ï¼ˆWaterï¼‰ã€ã€ã¾ãŸã¯åå‰ãŒã€ŒFishingSpotã€ãªã‚‰é‡£ã‚Šã‚’è¨±å¯ï¼
	if target and (target.Material == Enum.Material.Water or target.Name:find("FishingSpot") or target:IsA("Terrain")) then
		isFishing = true

		-- 1. æº–å‚™
		updateRodTip()
		rootPart.Anchored = true -- ä½“ã‚’å›ºå®š
		throwSound:Play()

		-- 2. ç«¿ã‚’å‰ã¸å€’ã™ï¼ˆæŠ•ã’ãŸå§¿å‹¢ã«ãªã‚‹ï¼‰
		tool.Grip = swingGrip

		-- 3. 0.4ç§’å¾Œã«ç³¸ï¼ˆBeamï¼‰ã‚’å‡ºã™
		task.wait(0.4) 
		hookPos.WorldPosition = mouse.Hit.p
		beam.Enabled = true
		
		-- â˜…NEWï¼šæ°´ã—ã¶ãã®éŸ³ã‚’é³´ã‚‰ã™ï¼
		local splash = game:GetService("SoundService"):FindFirstChild("SplashSound")
		if splash then splash:Play() end

		-- 4. é‡£ã‚Šã®å¾…æ©Ÿæ™‚é–“ï¼ˆé­šãŒå¯„ã£ã¦ãã‚‹ã¾ã§ï¼‰
		task.wait(2.2)

		-- â˜…ãƒ’ãƒƒãƒˆçŠ¶æ…‹ï¼ã“ã“ã§æ­¢ã¾ã£ã¦ã‚¯ãƒªãƒƒã‚¯ã‚’å¾…ã¤
		print("ğŸ£ é­šãŒé£Ÿã„ã¤ã„ãŸï¼ã‚¯ãƒªãƒƒã‚¯ã—ã¦åˆã‚ã›ã‚ï¼")
		isBiting = true -- ã€Œé£Ÿã„ã¤ãä¸­ã€ãƒ•ãƒ©ã‚°ã‚’ã‚ªãƒ³ã«ã™ã‚‹
		remote:FireServer("HIT") -- ç”»é¢ã«ã€Œï¼ã€ã‚’å‡ºã™
		
		-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã®ã‚’å¾…ã¤ï¼ˆæœ€å¤§2.5ç§’ï¼‰
		local reactionTime = 2.5
		local clicked = false
		local startTime = tick()
		
		-- ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã‚‹ã‹ã€æ™‚é–“ãŒåˆ‡ã‚Œã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—
		while tick() - startTime < reactionTime do
			if not isBiting then -- tool.Activated ã§ false ã«ã•ã‚ŒãŸã‚‰ã‚¯ãƒªãƒƒã‚¯æˆåŠŸ
				clicked = true
				break
			end
			task.wait(0.05)
		end
		
		if clicked then
			-- â˜…ã‚¯ãƒªãƒƒã‚¯æˆåŠŸï¼å·»ãä¸Šã’é–‹å§‹
			print("ğŸ¯ ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒãƒƒãƒãƒªï¼å·»ãä¸Šã’é–‹å§‹ï¼")
			
			-- å·»ãä¸Šã’æ¼”å‡ºï¼ˆã‚¬ã‚¯ã‚¬ã‚¯å‹•ã‹ã™ï¼ï¼‰
			local splashEffect = ReplicatedStorage:FindFirstChild("SplashEffect")
			local currentSplash = nil
			if splashEffect then
				currentSplash = splashEffect:Clone()
				currentSplash.Parent = hookPos
				currentSplash.Enabled = true
			end

			local reelStartTime = tick()
			while tick() - reelStartTime < 1.0 do
				-- ç«¿ã®è§’åº¦ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å°‘ã—å¤‰ãˆã¦ã‚¬ã‚¯ã‚¬ã‚¯ã•ã›ã‚‹
				local shake = CFrame.Angles(math.rad(60 + math.random(-5, 5)), math.rad(math.random(-5, 5)), 0)
				tool.Grip = normalGrip * shake
				task.wait(0.05)
			end

			-- ã‚µãƒ¼ãƒãƒ¼ã¸é‡£ã‚Šä¸Šã’å®Œäº†ã‚’å ±å‘Š
			print("ğŸ“¡ ã‚µãƒ¼ãƒãƒ¼ã¸é‡£ã‚Šä¸Šã’å®Œäº†ã‚’å ±å‘Š")
			remote:FireServer()

			if currentSplash then currentSplash:Destroy() end
		else
			-- â˜…å¤±æ•—ï¼šé­šã«é€ƒã’ã‚‰ã‚ŒãŸï¼
			print("ğŸŸ ã‚ã‚ãƒ¼ï¼é­šã«é€ƒã’ã‚‰ã‚ŒãŸ...")
		end

		-- 6. ã€é‡è¦ã€‘å¾Œç‰‡ä»˜ã‘
		isBiting = false
		task.wait(0.5) -- æ¼”å‡ºã®ä½™éŸ»
		beam.Enabled = false
		rootPart.Anchored = false 
		tool.Grip = normalGrip -- ç«¿ã‚’å…ƒã®ä½ç½®ã«æˆ»ã™
		isFishing = false

		print("ãƒªã‚»ãƒƒãƒˆå®Œäº†ï¼šæ¬¡ã®ã‚­ãƒ£ã‚¹ãƒˆãŒå¯èƒ½ã§ã™")
	end
end)

-- â˜…NEWï¼šã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†ï¼ˆé£Ÿã„ã¤ãä¸­ãªã‚‰å·»ãä¸Šã’ã‚’è¨±å¯ã™ã‚‹ï¼‰
tool.Activated:Connect(function()
	if isBiting then
		isBiting = false -- whileãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã•ã›ã‚‹åˆå›³
		print("ğŸ–±ï¸ ã‚¯ãƒªãƒƒã‚¯æ¤œçŸ¥ï¼šåˆã‚ã›ã«æˆåŠŸï¼")
	end
end)
