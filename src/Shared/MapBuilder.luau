-- MapBuilder.luau
-- ãƒãƒƒãƒ—ã®è¨­è¨ˆå›³ï¼šStage 0 é…ç½®å®Œæˆç‰ˆï¼ˆã‚·ã‚§ãƒ•ç›´å£²ãƒ»çœ‹æ¿å³ãƒ»ç„šç«ä¸­å¤®ï¼‰
local MapBuilder = {}

local terrain = workspace.Terrain
local Players = game:GetService("Players")

-- NPCsã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (é«˜å“è³ªã‚¢ãƒã‚¿ãƒ¼å¬å–š)
local function createNPC(name, userId, pos, lookAt)
    -- åŒåãŒã„ã‚Œã°å‰Šé™¤
    for _, obj in pairs(workspace:GetChildren()) do
        if obj.Name == name then obj:Destroy() end
    end

    print("ğŸ‘¤ [" .. name .. "] ã‚’å¬å–šä¸­... (UserId: " .. userId .. ")")
    
    local model
    local success, err = pcall(function()
        model = Players:CreateHumanoidModelFromUserId(userId)
    end)

    if not success or not model then
        warn("âš ï¸ ã‚¢ãƒã‚¿ãƒ¼å¬å–šå¤±æ•—: " .. tostring(err))
        model = Instance.new("Model")
        local torso = Instance.new("Part", model)
        torso.Name = "Torso"; torso.Size = Vector3.new(2, 2, 1); torso.Anchored = true
        Instance.new("Humanoid", model)
        model.PrimaryPart = torso
    end

    model.Name = name
    model.Parent = workspace
    
    -- ä½ç½®åˆã‚ã›
    model:PivotTo(CFrame.new(pos + Vector3.new(0, 3, 0)))

    -- çµ„ã¿ç«‹ã¦å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰å›ºå®šã¨å‘ãè¨­å®š
    task.spawn(function()
        task.wait(2.0)
        if model and model.Parent then
            for _, p in pairs(model:GetDescendants()) do
                if p:IsA("BasePart") then
                    p.Anchored = true
                    p.CanCollide = true
                end
            end
            -- æµ·ï¼ˆZæ–¹å‘ï¼‰ã‚’æ­£å¯¾ã•ã›ã‚‹
            local currentPos = model:GetPivot().Position
            model:PivotTo(CFrame.lookAt(currentPos, Vector3.new(currentPos.X, currentPos.Y, currentPos.Z + 10)))
        end
    end)

    return model
end

-- èˆå°æ§‹ç¯‰
function MapBuilder.buildBase()
    terrain:Clear()
    terrain:FillBlock(CFrame.new(0, -52, 0), Vector3.new(2000, 100, 2000), Enum.Material.Water)
    terrain:FillBlock(CFrame.new(0, -5, 0), Vector3.new(300, 10, 300), Enum.Material.Sand)
    if workspace:FindFirstChild("Baseplate") then workspace.Baseplate:Destroy() end
end

function MapBuilder.buildPier()
    if workspace:FindFirstChild("FishingPier") then workspace.FishingPier:Destroy() end
    local folder = Instance.new("Folder", workspace); folder.Name = "FishingPier"
    local startZ, length, height, width = 130, 100, 2.5, 14
    for i = 0, length, 4 do
        local plank = Instance.new("Part", folder)
        plank.Size = Vector3.new(width, 1, 3.8); plank.CFrame = CFrame.new(0, height, startZ + i); 
        plank.Material = Enum.Material.WoodPlanks; plank.Color = Color3.fromRGB(110, 85, 60); plank.Anchored = true
    end
end

-- é€²åŒ–ãƒœãƒ¼ãƒ‰
function MapBuilder.createUpgradeBoard(parent, cost, pos, nextStage, buildingType)
    local board = Instance.new("Part", parent)
    board.Name = "UpgradeBoard"; board.Size = Vector3.new(4, 5, 0.5); board.Position = pos
    board.Color = Color3.fromRGB(50, 200, 50); board.Anchored = true
    board.CFrame = CFrame.new(board.Position) * CFrame.Angles(0, math.rad(180), 0) -- æµ·å‘ã

    local sg = Instance.new("SurfaceGui", board); sg.Face = Enum.NormalId.Front
    local txt = Instance.new("TextLabel", sg); txt.Size = UDim2.new(1, 0, 1, 0); txt.BackgroundTransparency = 1
    txt.Text = "ğŸ”¨ é€²åŒ–ã•ã›ã‚‹\nè²»ç”¨: " .. cost .. " Gold"; txt.TextColor3 = Color3.fromRGB(255, 255, 255)
    txt.Font = Enum.Font.GothamBold; txt.TextScaled = true

    local prompt = Instance.new("ProximityPrompt", board); prompt.ActionText = "é€²åŒ–ã•ã›ã‚‹ (Stage " .. nextStage .. ")"
    prompt.ObjectText = buildingType; prompt.HoldDuration = 1.0
end

-- æ¼”å‡ºï¼šç´™å¹é›ª
function MapBuilder.playUpgradeEffect(pos)
    local part = Instance.new("Part")
    part.Anchored, part.CanCollide = true, false; part.Transparency = 1; part.Position = pos + Vector3.new(0, 5, 0); part.Parent = workspace
    local confetti = Instance.new("ParticleEmitter")
    confetti.Texture = "rbxassetid://6071575923"
    confetti.Color = ColorSequence.new({ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 0)), ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 255, 255))})
    confetti.Rate = 200; confetti.Parent = part
    local sound = Instance.new("Sound")
    sound.SoundId = "rbxassetid://9060788686"; sound.Parent = part; sound:Play()
    task.delay(4, function() part:Destroy() end)
end

-- 3. ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ (Stage 0: ã‚·ã‚§ãƒ•ã«ç›´æ¥è©±ã—ã‹ã‘ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«)
function MapBuilder.buildRestaurant(stage)
    if workspace:FindFirstChild("FoodStand") then workspace.FoodStand:Destroy() end
    local folder = Instance.new("Folder", workspace); folder.Name = "FoodStand"
    folder:SetAttribute("Stage", stage)
    local basePos = Vector3.new(40, 1.5, 110)

    if stage == 0 then
        -- ç„šãç« (ä¸­å¤®)
        local bonfire = Instance.new("Part", folder)
        bonfire.Name = "Bonfire"; bonfire.Position = basePos; bonfire.Anchored = true
        Instance.new("Fire", bonfire)

        -- ã‚·ã‚§ãƒ• (å·¦å´ï¼šæ¡Ÿæ©‹ã‹ã‚‰è¦‹ã¦ X+)
        -- ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãªãã—ã€ç„šãç«ã®ã™ãå·¦å´ã«ç«‹ãŸã›ã‚‹
        local npcPos = basePos + Vector3.new(8, 0, 1) -- ç„šãç«ã®æ¨ª
        createNPC("Chef", 524027791, npcPos, npcPos + Vector3.new(0, 0, 50))

        -- é€²åŒ–ãƒœãƒ¼ãƒ‰ (å³å´ï¼šæ¡Ÿæ©‹ã‹ã‚‰è¦‹ã¦ X-)
        MapBuilder.createUpgradeBoard(folder, 500, basePos + Vector3.new(-8, 1.5, 0), 1, "Restaurant")
        
        print("ğŸ³ [Stage 0] ã‚·ã‚§ãƒ•ã«ç›´æ¥è©±ã—ã‹ã‘ã¦é­šã‚’å£²ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼")
    else
        -- Stage 1 ä»¥é™ï¼ˆå°†æ¥ã®å±‹å°ï¼‰
        local stand = Instance.new("Part", folder)
        stand.Size = Vector3.new(15, 1, 10); stand.Position = basePos; stand.Anchored = true
        stand.Color = Color3.fromRGB(150, 100, 50)
        print("ğŸ—ï¸ Stage " .. stage .. " å»ºç¯‰ä¸­...")
    end
end

-- ã™ã¹ã¦æ§‹ç¯‰
function MapBuilder.buildAll()
    MapBuilder.buildBase(); MapBuilder.buildPier(); MapBuilder.buildRestaurant(0)
    local spawn = workspace:FindFirstChild("SpawnLocation") or Instance.new("SpawnLocation", workspace)
    spawn.Position = Vector3.new(0, 5, 120); spawn.Anchored = true
end

return MapBuilder
