-- MapBuilder.luau
-- ãƒãƒƒãƒ—ã®è¨­è¨ˆå›³ï¼šStage 0 å¾¹åº•ãƒªãƒ•ã‚¡ã‚¤ãƒ³ç‰ˆï¼ˆç„šãç«ã¨ãƒªã‚¢ãƒ«ãªä¸¸å¤ªï¼‰
local MapBuilder = {}

local terrain = workspace.Terrain
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- æ¼”ç¿’ï¼šç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
function MapBuilder.playUpgradeEffect(pos)
    local part = Instance.new("Part")
    part.Anchored, part.CanCollide = true, false
    part.Transparency = 1; part.Position = pos + Vector3.new(0, 5, 0); part.Parent = workspace

    local confetti = Instance.new("ParticleEmitter")
    confetti.Texture = "rbxassetid://6071575923"
    confetti.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 255)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 255, 0)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 0, 0))
    })
    confetti.Rate = 300; confetti.Parent = part

    local sound = Instance.new("Sound")
    sound.SoundId = "rbxassetid://9060788686"
    sound.Parent = part; sound:Play()

    task.delay(3, function() confetti.Enabled = false; task.wait(4); part:Destroy() end)
end

-- 1. ä¸–ç•Œã®åœŸå°ï¼ˆãƒ•ãƒ©ãƒƒãƒˆãªç ‚æµœï¼‰
function MapBuilder.buildBase()
    terrain:Clear()
    terrain:FillBlock(CFrame.new(0, -52, 0), Vector3.new(2000, 100, 2000), Enum.Material.Water)
    terrain:FillBlock(CFrame.new(0, -5, 0), Vector3.new(300, 10, 300), Enum.Material.Sand)
    if workspace:FindFirstChild("Baseplate") then workspace.Baseplate:Destroy() end
end

-- 2. æ¡Ÿæ©‹
function MapBuilder.buildPier()
    if workspace:FindFirstChild("FishingPier") then workspace.FishingPier:Destroy() end
    local folder = Instance.new("Folder", workspace); folder.Name = "FishingPier"
    local startZ, length, height, width = 130, 100, 2.5, 14
    for i = 0, length, 4 do
        local plank = Instance.new("Part", folder)
        plank.Size = Vector3.new(width, 1, 3.8); plank.CFrame = CFrame.new(0, height, startZ + i); 
        plank.Material = Enum.Material.WoodPlanks; plank.Color = Color3.fromRGB(110, 85, 60); plank.Anchored = true
    end
end

-- é€²åŒ–ç”¨ãƒœãƒ¼ãƒ‰
function MapBuilder.createUpgradeBoard(parent, cost, pos, nextStage, buildingType)
    local board = Instance.new("Part", parent)
    board.Name = "UpgradeBoard"; board.Size = Vector3.new(4, 5, 0.5); board.Position = pos
    board.Color = Color3.fromRGB(50, 200, 50); board.Anchored = true

    local sg = Instance.new("SurfaceGui", board); sg.Face = Enum.NormalId.Front
    local txt = Instance.new("TextLabel", sg); txt.Size = UDim2.new(1, 0, 1, 0); txt.BackgroundTransparency = 1
    txt.Text = "ğŸ”¨ é€²åŒ–ã•ã›ã‚‹\nè²»ç”¨: " .. cost .. " Gold"; txt.TextColor3 = Color3.fromRGB(255, 255, 255)
    txt.Font = Enum.Font.GothamBold; txt.TextScaled = true

    local prompt = Instance.new("ProximityPrompt", board); prompt.ActionText = "é€²åŒ–ã•ã›ã‚‹ (Stage " .. nextStage .. ")"
    prompt.ObjectText = buildingType; prompt.HoldDuration = 1.0
end

-- 3. ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ (Stage 0: ç„šãç«ã¨ãƒªã‚¢ãƒ«ãªä¸¸å¤ª)
function MapBuilder.buildRestaurant(stage)
    if workspace:FindFirstChild("FoodStand") then workspace.FoodStand:Destroy() end
    local folder = Instance.new("Folder", workspace); folder.Name = "FoodStand"
    folder:SetAttribute("Stage", stage)
    local basePos = Vector3.new(40, 1.5, 90)

    if stage == 0 then
        -- ç„šãç«
        local bonfire = Instance.new("Part", folder)
        bonfire.Name = "Bonfire"; bonfire.Size = Vector3.new(4, 1, 4); bonfire.Position = basePos; 
        bonfire.Color = Color3.fromRGB(50, 30, 20); bonfire.Material = Enum.Material.Wood; bonfire.Anchored = true
        Instance.new("Fire", bonfire).Size = 6

        -- ãƒªã‚¢ãƒ«ãªä¸¸å¤ªã®æ¤…å­ (MeshPartã‚’ä½¿ç”¨)
        for i = -1, 1, 2 do
            local log = Instance.new("MeshPart", folder)
            log.Name = "LogSeat"
            -- ãƒ„ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã§ã‚ˆãä½¿ã‚ã‚Œã‚‹é«˜å“è³ªãªä¸¸å¤ªã®MeshID
            log.MeshId = "rbxassetid://474339116" 
            log.TextureID = "rbxassetid://474339145"
            log.Size = Vector3.new(2, 6, 2)
            -- æ¨ªã«å€’ã—ã¦é…ç½®
            log.CFrame = CFrame.new(basePos + Vector3.new(6 * i, 0, 0)) * CFrame.Angles(0, 0, math.pi/2)
            log.Anchored = true
        end

        -- é€²åŒ–ãƒœãƒ¼ãƒ‰
        MapBuilder.createUpgradeBoard(folder, 500, basePos + Vector3.new(12, 2.5, 0), 1, "Restaurant")
        
        print("ğŸ”¥ [Stage 0] ç„šãç«ã¨ä¸¸å¤ªã®ã¿ã®é™ã‹ãªã‚¹ã‚¿ãƒ¼ãƒˆã§ã™")
    else
        -- Stage 1ä»¥é™ã¯ä¸€æ—¦ã€çœ‹æ¿ã®ã¿å‡ºã™ï¼ˆå¾Œã»ã©å„Stageã‚’ãƒªã‚¿ã‚¤ã‚¢ï¼‰
        local tempSign = Instance.new("Part", folder)
        tempSign.Size = Vector3.new(10, 5, 1); tempSign.Position = basePos + Vector3.new(0, 5, 0); tempSign.Anchored = true
        print("ğŸ—ï¸ Stage " .. stage .. " ã¯ç¾åœ¨å»ºç¯‰ä¸­ã§ã™...")
    end
end

-- 4. é‡£å…·å±‹ (ä»Šã¯ä¿ç•™)
function MapBuilder.buildUpgradeShop(stage)
    if workspace:FindFirstChild("UpgradeShop") then workspace.UpgradeShop:Destroy() end
    -- ä»Šã¯ä½•ã‚‚ã—ãªã„
end

-- 5. ã™ã¹ã¦ã‚’æ§‹ç¯‰
function MapBuilder.buildAll()
    MapBuilder.buildBase()
    MapBuilder.buildPier()
    MapBuilder.buildRestaurant(0)
    MapBuilder.buildUpgradeShop(0)
    
    local spawn = workspace:FindFirstChild("SpawnLocation") or Instance.new("SpawnLocation", workspace)
    spawn.Position = Vector3.new(0, 5, 120); spawn.Anchored = true
    print("ğŸš€ [ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ“ãƒ«ãƒ€ãƒ¼] ç¬¬1æ­©ï¼šç„šãç«ã®å®Œæˆã§ã™ï¼")
end

return MapBuilder
